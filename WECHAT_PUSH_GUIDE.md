# ğŸ“± å¾®ä¿¡æ¨é€é›†æˆæŒ‡å—

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•å°†æ™ºèƒ½æ–°é—»æ¨é€ç³»ç»Ÿé›†æˆåˆ°å¾®ä¿¡ï¼Œæ”¯æŒå¤šç§å¾®ä¿¡æ¨é€æ–¹å¼ã€‚

## ğŸ¯ æ”¯æŒçš„å¾®ä¿¡æ¨é€æ–¹å¼

### 1. **ä¼ä¸šå¾®ä¿¡ (æ¨è)**
- âœ… å®˜æ–¹APIæ”¯æŒ
- âœ… ç¨³å®šå¯é 
- âœ… æ”¯æŒå¯Œæ–‡æœ¬æ ¼å¼
- âœ… æ”¯æŒç¾¤å‘å’ŒæŒ‡å®šç”¨æˆ·
- âœ… å…è´¹ä½¿ç”¨

### 2. **å¾®ä¿¡å…¬ä¼—å·**
- âœ… æœåŠ¡å·å¯ä¸»åŠ¨æ¨é€
- âœ… è®¢é˜…å·æœ‰é™åˆ¶
- âœ… éœ€è¦è®¤è¯
- âœ… ç”¨æˆ·éœ€è¦å…³æ³¨

### 3. **å¾®ä¿¡æœºå™¨äºº (ç¬¬ä¸‰æ–¹)**
- âœ… åŸºäºWebhook
- âœ… éœ€è¦ç¬¬ä¸‰æ–¹æœåŠ¡
- âœ… å¯èƒ½æœ‰ç¨³å®šæ€§é—®é¢˜

### 4. **ä¸ªäººå¾®ä¿¡ (ä¸æ¨è)**
- âŒ å®˜æ–¹ä¸æ”¯æŒAPI
- âŒ éœ€è¦æ¨¡æ‹Ÿç™»å½•
- âŒ å¯èƒ½è¢«å°å·
- âŒ ä¸ç¨³å®š

## ğŸš€ æ¨èæ–¹æ¡ˆï¼šä¼ä¸šå¾®ä¿¡

### ä¸ºä»€ä¹ˆé€‰æ‹©ä¼ä¸šå¾®ä¿¡ï¼Ÿ
1. **å®˜æ–¹æ”¯æŒ**: è…¾è®¯å®˜æ–¹æä¾›çš„ä¼ä¸šçº§API
2. **ç¨³å®šå¯é **: ä¼ä¸šçº§æœåŠ¡ï¼Œ99.9%å¯ç”¨æ€§
3. **åŠŸèƒ½ä¸°å¯Œ**: æ”¯æŒæ–‡æœ¬ã€Markdownã€å›¾æ–‡ç­‰å¤šç§æ ¼å¼
4. **å…è´¹ä½¿ç”¨**: åŸºç¡€åŠŸèƒ½å®Œå…¨å…è´¹
5. **æ˜“äºé›†æˆ**: æ¸…æ™°çš„APIæ–‡æ¡£å’ŒSDK

## ğŸ“‹ ä¼ä¸šå¾®ä¿¡é…ç½®æ­¥éª¤

### æ­¥éª¤1: æ³¨å†Œä¼ä¸šå¾®ä¿¡
1. è®¿é—® https://work.weixin.qq.com/
2. æ³¨å†Œä¼ä¸šï¼ˆå¯ä»¥ä½¿ç”¨ä¸ªäººèº«ä»½æ³¨å†Œï¼‰
3. å®Œæˆä¼ä¸šè®¤è¯ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰

### æ­¥éª¤2: åˆ›å»ºåº”ç”¨
1. è¿›å…¥ã€Œåº”ç”¨ç®¡ç†ã€
2. ç‚¹å‡»ã€Œåˆ›å»ºåº”ç”¨ã€
3. å¡«å†™åº”ç”¨ä¿¡æ¯ï¼š
   - åº”ç”¨åç§°: `æ–°é—»æ¨é€ç³»ç»Ÿ`
   - åº”ç”¨Logo: ä¸Šä¼ å›¾æ ‡
   - åº”ç”¨ä»‹ç»: æ™ºèƒ½æ–°é—»å’Œè‚¡ç¥¨æ¨é€
4. åˆ›å»ºå®Œæˆåï¼Œè®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š
   - **ä¼ä¸šID** (CorpID)
   - **åº”ç”¨ID** (AgentID)
   - **åº”ç”¨Secret** (Secret)

### æ­¥éª¤3: é…ç½®åº”ç”¨æƒé™
1. è¿›å…¥åº”ç”¨è¯¦æƒ…
2. é…ç½®ã€Œå¯è§èŒƒå›´ã€ï¼šé€‰æ‹©éœ€è¦æ¥æ”¶æ¨é€çš„æˆå‘˜
3. é…ç½®ã€Œåº”ç”¨æƒé™ã€ï¼šç¡®ä¿æœ‰å‘é€æ¶ˆæ¯æƒé™

### æ­¥éª¤4: è·å–ç¯å¢ƒå˜é‡
å°†ä»¥ä¸‹ä¿¡æ¯æ·»åŠ åˆ° `config/.env` æ–‡ä»¶ï¼š

```bash
# ä¼ä¸šå¾®ä¿¡é…ç½®
WECHAT_CORP_ID="ä½ çš„ä¼ä¸šID"
WECHAT_AGENT_ID="ä½ çš„åº”ç”¨ID"
WECHAT_SECRET="ä½ çš„åº”ç”¨Secret"
WECHAT_TO_USER="@all"  # æ¥æ”¶ç”¨æˆ·ï¼Œ@allè¡¨ç¤ºæ‰€æœ‰ï¼Œæˆ–æŒ‡å®šç”¨æˆ·ID
```

## ğŸ”§ ä»£ç é›†æˆ

### 1. åˆ›å»ºä¼ä¸šå¾®ä¿¡å‘é€å™¨
å·²åˆ›å»º `src/utils/wechat_sender.py` æ–‡ä»¶ï¼ŒåŒ…å«å®Œæ•´çš„ä¼ä¸šå¾®ä¿¡å‘é€åŠŸèƒ½ã€‚

### 2. æ›´æ–°æ¶ˆæ¯å‘é€å™¨
ä¿®æ”¹ `src/utils/message_sender.py`ï¼Œæ·»åŠ å¾®ä¿¡å‘é€æ”¯æŒï¼š

```python
def send_wechat_message(message: str, config: Dict = None) -> bool:
    """å‘é€æ¶ˆæ¯åˆ°ä¼ä¸šå¾®ä¿¡"""
    try:
        from .wechat_sender import WeChatSender
        
        sender = WeChatSender()
        return sender.send_news_report(message)
    except Exception as e:
        logger.error(f"å¾®ä¿¡æ¶ˆæ¯å‘é€å¤±è´¥: {e}")
        return False
```

### 3. æ›´æ–°æ¨é€ç³»ç»Ÿ
ä¿®æ”¹ `src/common/news_stock_pusher_optimized.py`ï¼Œæ·»åŠ å¾®ä¿¡æ¨é€é€‰é¡¹ï¼š

```python
def send_report(self, report: str) -> bool:
    """å‘é€æŠ¥å‘Šåˆ°æ‰€æœ‰é…ç½®çš„å¹³å°"""
    results = []
    
    # WhatsAppæ¨é€
    if self.config.get("ENABLE_WHATSAPP", True):
        results.append(self._send_whatsapp(report))
    
    # å¾®ä¿¡æ¨é€
    if self.config.get("ENABLE_WECHAT", False):
        results.append(self._send_wechat(report))
    
    return any(results)
```

## âš™ï¸ é…ç½®ç¤ºä¾‹

### å®Œæ•´çš„ç¯å¢ƒå˜é‡é…ç½®
```bash
# WhatsAppé…ç½®
WHATSAPP_NUMBER="+8618966719971"
OPENCLAW_PATH="/home/admin/.npm-global/bin/openclaw"
ENABLE_WHATSAPP=true

# ä¼ä¸šå¾®ä¿¡é…ç½®
WECHAT_CORP_ID="wwxxxxxxxxxxxxxxxx"
WECHAT_AGENT_ID="1000002"
WECHAT_SECRET="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
WECHAT_TO_USER="@all"
ENABLE_WECHAT=true

# æ¨é€æ—¶é—´é…ç½®
STOCK_PUSH_START=8
STOCK_PUSH_END=18
NEWS_PUSH_START=8
NEWS_PUSH_END=22

# æ•°æ®åº“é…ç½®
DATABASE_PATH="./news_cache.db"
LOG_LEVEL="INFO"
```

## ğŸ§ª æµ‹è¯•å¾®ä¿¡æ¨é€

### æµ‹è¯•è„šæœ¬
```bash
# æµ‹è¯•ä¼ä¸šå¾®ä¿¡é…ç½®
cd clean_news_push
python3 -c "
import os
os.environ['WECHAT_CORP_ID'] = 'ä½ çš„ä¼ä¸šID'
os.environ['WECHAT_AGENT_ID'] = 'ä½ çš„åº”ç”¨ID'
os.environ['WECHAT_SECRET'] = 'ä½ çš„åº”ç”¨Secret'

from src.utils.wechat_sender import WeChatSender
sender = WeChatSender()

# æµ‹è¯•æ¶ˆæ¯
test_msg = 'ğŸ”” æµ‹è¯•æ¶ˆæ¯\\nğŸ“… æ—¶é—´: 2026-02-04\\nâœ… å¾®ä¿¡æ¨é€æµ‹è¯•æˆåŠŸ'
success = sender.send_text_message(test_msg, '@all')

if success:
    print('âœ… å¾®ä¿¡æ¨é€æµ‹è¯•æˆåŠŸï¼')
else:
    print('âŒ å¾®ä¿¡æ¨é€æµ‹è¯•å¤±è´¥')
"
```

### é›†æˆæµ‹è¯•
```bash
# è¿è¡Œå®Œæ•´çš„æ¨é€æµ‹è¯•ï¼ˆåŒ…å«å¾®ä¿¡ï¼‰
cd clean_news_push
python3 -m src.common.auto_push_system_optimized_final --test --wechat
```

## ğŸ“± æ¶ˆæ¯æ ¼å¼

### æ–‡æœ¬æ¶ˆæ¯æ ¼å¼
```
ğŸ“° æ–°é—»æ‘˜è¦ (16:00)
â€¢ [é‡è¦] æ ‡é¢˜1 (æ¥æº: BBC)
â€¢ [å…³æ³¨] æ ‡é¢˜2 (æ¥æº: åå°”è¡—æ—¥æŠ¥)

ğŸ“ˆ è‚¡ç¥¨ç›‘æ§
â€¢ é˜¿é‡Œå·´å·´: Â¥165.00 (+1.2%)
â€¢ å°ç±³é›†å›¢: Â¥34.50 (-0.5%)

ğŸ’° è´¢ç»è¦é—»
â€¢ æ ‡é¢˜ (æ¥æº: CNBC)
```

### Markdownæ¶ˆæ¯æ ¼å¼ (æ¨è)
```markdown
### ğŸ“° æ–°é—»æ‘˜è¦ (16:00)
- **é‡è¦** æ ‡é¢˜1 _(æ¥æº: BBC)_
- **å…³æ³¨** æ ‡é¢˜2 _(æ¥æº: åå°”è¡—æ—¥æŠ¥)_

### ğŸ“ˆ è‚¡ç¥¨ç›‘æ§
- **é˜¿é‡Œå·´å·´**: Â¥165.00 <font color=\"green\">(+1.2%)</font>
- **å°ç±³é›†å›¢**: Â¥34.50 <font color=\"red\">(-0.5%)</font>

### ğŸ’° è´¢ç»è¦é—»
- æ ‡é¢˜ _(æ¥æº: CNBC)_
```

## ğŸ”„ å¤šå¹³å°æ¨é€ç­–ç•¥

### æ¨é€ä¼˜å…ˆçº§
1. **ä¼ä¸šå¾®ä¿¡** (ä¸»æ¨) - ç¨³å®šå¯é ï¼ŒåŠŸèƒ½ä¸°å¯Œ
2. **WhatsApp** (å¤‡ç”¨) - ä¸ªäººä½¿ç”¨ï¼Œå³æ—¶æ€§é«˜
3. **é‚®ä»¶** (å¯é€‰) - ä½œä¸ºå¤‡ä»½è®°å½•

### æ¨é€æ—¶é—´ä¼˜åŒ–
- **ä¸Šç­æ—¶é—´** (09:00-18:00): ä¸»è¦æ¨é€åˆ°ä¼ä¸šå¾®ä¿¡
- **éä¸Šç­æ—¶é—´**: ä¸»è¦æ¨é€åˆ°WhatsApp
- **é‡è¦è­¦æŠ¥**: åŒæ—¶æ¨é€åˆ°æ‰€æœ‰å¹³å°

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**1. è·å–è®¿é—®ä»¤ç‰Œå¤±è´¥**
```
é”™è¯¯: invalid credential
```
**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ä¼ä¸šIDã€åº”ç”¨IDã€Secretæ˜¯å¦æ­£ç¡®
- ç¡®è®¤åº”ç”¨Secretæ²¡æœ‰æ³„éœ²æˆ–é‡ç½®
- æ£€æŸ¥ç½‘ç»œè¿æ¥

**2. æ¶ˆæ¯å‘é€å¤±è´¥**
```
é”™è¯¯: userid not found
```
**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥æ¥æ”¶ç”¨æˆ·IDæ˜¯å¦æ­£ç¡®
- ç¡®è®¤ç”¨æˆ·åœ¨åº”ç”¨å¯è§èŒƒå›´å†…
- æ£€æŸ¥åº”ç”¨æƒé™é…ç½®

**3. æ¶ˆæ¯æ ¼å¼é—®é¢˜**
```
é”™è¯¯: invalid message type
```
**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥æ¶ˆæ¯å†…å®¹æ ¼å¼
- é¿å…ä½¿ç”¨ç‰¹æ®Šå­—ç¬¦
- æ§åˆ¶æ¶ˆæ¯é•¿åº¦ï¼ˆä¸è¶…è¿‡2048å­—ç¬¦ï¼‰

### è°ƒè¯•å·¥å…·
```bash
# æŸ¥çœ‹ä¼ä¸šå¾®ä¿¡APIæ—¥å¿—
tail -f logs/wechat.log

# æµ‹è¯•APIè¿æ¥
curl "https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=YOUR_CORPID&corpsecret=YOUR_SECRET"

# æ£€æŸ¥åº”ç”¨çŠ¶æ€
ç™»å½•ä¼ä¸šå¾®ä¿¡åå° â†’ åº”ç”¨ç®¡ç† â†’ æ–°é—»æ¨é€ç³»ç»Ÿ â†’ åº”ç”¨è¯¦æƒ…
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æ¶ˆæ¯å‘é€ä¼˜åŒ–
1. **æ‰¹é‡å‘é€**: åˆå¹¶å¤šæ¡æ–°é—»ä¸ºä¸€æ¡æ¶ˆæ¯
2. **å¼‚æ­¥å‘é€**: ä½¿ç”¨çº¿ç¨‹æ± å¹¶å‘å‘é€
3. **å¤±è´¥é‡è¯•**: è‡ªåŠ¨é‡è¯•å¤±è´¥çš„æ¶ˆæ¯
4. **é€Ÿç‡é™åˆ¶**: éµå®ˆå¾®ä¿¡APIè°ƒç”¨é™åˆ¶

### ä»£ç ä¼˜åŒ–
```python
# ä½¿ç”¨è¿æ¥æ± 
import requests
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry

session = requests.Session()
retry_strategy = Retry(
    total=3,
    backoff_factor=1,
    status_forcelist=[429, 500, 502, 503, 504]
)
adapter = HTTPAdapter(max_retries=retry_strategy)
session.mount("https://", adapter)
```

## ğŸš€ éƒ¨ç½²æŒ‡å—

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
1. **å®‰å…¨é…ç½®**:
   ```bash
   # ä¿æŠ¤æ•æ„Ÿä¿¡æ¯
   chmod 600 config/.env
   # ä½¿ç”¨ç¯å¢ƒå˜é‡è€Œéæ–‡ä»¶
   export WECHAT_SECRET=$(cat /run/secrets/wechat_secret)
   ```

2. **ç›‘æ§é…ç½®**:
   ```bash
   # ç›‘æ§å¾®ä¿¡APIè°ƒç”¨
   monitoring:
     wechat_api:
       success_rate: > 99%
       response_time: < 1s
       error_alerts: true
   ```

3. **å¤‡ä»½ç­–ç•¥**:
   - å®šæœŸå¤‡ä»½ä¼ä¸šå¾®ä¿¡é…ç½®
   - è®°å½•æ¶ˆæ¯å‘é€æ—¥å¿—
   - é…ç½®å¤±è´¥å‘Šè­¦

### æ›´æ–°ç»´æŠ¤
```bash
# æ›´æ–°å¾®ä¿¡å‘é€å™¨
git pull origin master
pip install -r requirements.txt

# é‡å¯æœåŠ¡
systemctl restart news-push.service

# éªŒè¯é…ç½®
python3 scripts/check_wechat_config.py
```

## ğŸ“š å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£
- [ä¼ä¸šå¾®ä¿¡APIæ–‡æ¡£](https://work.weixin.qq.com/api/doc/90000/90135/90664)
- [æ¶ˆæ¯æ¨é€æ¥å£](https://work.weixin.qq.com/api/doc/90000/90135/90236)
- [é”™è¯¯ç è¯´æ˜](https://work.weixin.qq.com/api/doc/90000/90135/90313)

### å¼€æºé¡¹ç›®
- [ä¼ä¸šå¾®ä¿¡Python SDK](https://github.com/sbzhu/weworkapi_python)
- [å¾®ä¿¡æœºå™¨äººæ¡†æ¶](https://github.com/wechaty/wechaty)
- [æ¶ˆæ¯æ¨é€å·¥å…·](https://github.com/easychen/pushdeer)

### ç¤¾åŒºæ”¯æŒ
- [ä¼ä¸šå¾®ä¿¡å¼€å‘è€…ç¤¾åŒº](https://developer.work.weixin.qq.com/)
- [GitHub Issues](https://github.com/xuefeng19988/news_push/issues)
- [æŠ€æœ¯åšå®¢](https://blog.openclaw.ai/)

## ğŸ‰ å¼€å§‹ä½¿ç”¨

### å¿«é€Ÿå¼€å§‹
1. æ³¨å†Œä¼ä¸šå¾®ä¿¡å¹¶åˆ›å»ºåº”ç”¨
2. é…ç½®ç¯å¢ƒå˜é‡
3. è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯
4. é›†æˆåˆ°æ¨é€ç³»ç»Ÿ
5. äº«å—å¾®ä¿¡æ¨é€æœåŠ¡ï¼

### è·å–å¸®åŠ©
å¦‚æœ‰é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„æ•…éšœæ’é™¤éƒ¨åˆ†
2. æ£€æŸ¥ä¼ä¸šå¾®ä¿¡åå°çŠ¶æ€
3. æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—æ–‡ä»¶
4. åœ¨GitHubæäº¤Issue

---

**æœ€åæ›´æ–°**: 2026-02-04  
**ç‰ˆæœ¬**: 1.0.0  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª